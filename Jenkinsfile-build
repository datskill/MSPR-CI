#!groovy

pipeline {
    agent any
    tools {
        maven 'maven'
    }
    environment {
        // This can be nexus3 or nexus2
        NEXUS_VERSION = "nexus3"
        // This can be http or https
        NEXUS_PROTOCOL = "http"
        // Where your Nexus is running
        NEXUS_URL = "nexus3:8081"
        // Repository where we will upload the artifact
        NEXUS_REPOSITORY = "repo-erp"
        // Jenkins credential id to authenticate to Nexus OSS
        NEXUS_CREDENTIAL_ID = "nexus-credentials"
    }

    stages {
        stage("Code Checkout") {
            steps {
                git branch: 'master',
                        url: 'https://github.com/datskill/MSPR-CI.git'
            }
        }
        stage("Building") {
            steps {
                sh "mvn clean package"
                junit '**/target/surefire-reports/*xml'
            }
        }
        stage('Checkstyle') {
            steps {
                sh "mvn checkstyle:checkstyle pmd:pmd pmd:cpd com.github.spotbugs:spotbugs-maven-plugin:3.1.7:spotbugs"
                recordIssues(
                        enabledForFailure: true, aggregatingResults: false,
                        tools: [
                                [tool:[$class: checkStyle(pattern: '**/target/checkstyle-result.xml', reportEncoding: 'UTF-8')]],
                                [tool:[$class: pmdParser(pattern: '**/target/pmd.xml', reportEncoding: 'UTF-8')]],
                                [tool: [$class: cpd(pattern: '**/target/cpd.xml', reportEncoding: 'UTF-8')]],
                                [tool: [$class: spotBugs(pattern: '**/target/spotbugsXml.xml')]]
                        ]
                )
            }
        }
        stage('SonarQube analysis') {
            steps {
                withSonarQubeEnv(credentialsId: '', installationName: 'sonarqube') {
                    // You can override the credential to be used
                    sh 'mvn org.sonarsource.scanner.maven:sonar-maven-plugin:3.6.0.1398:sonar'
                }
            }
        }
    }
}

